<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Pesquisa de Produtos</title>
	<link rel="stylesheet" href="static/style.css">
</head>	

<body id = "dados">
  <h2>Cadastro de Produto</h2>
  <form id="formProduto">
    <label>Nome: <input type="text" id="nome"></label><br><br>
    <label>Estoque: <input type="number" id="estoque"></label><br><br>
    <label>Local: <input type="text" id="local"></label><br><br>
    <button type="submit">Cadastrar</button>
	<button onclick = "clearTable()">Limpar</button>
  </form>

  <p id="resposta"></p>

  <script>
    document.getElementById("formProduto").addEventListener("submit", async function(event) {
      event.preventDefault();

      const nome = document.getElementById("nome").value;
      const estoque = document.getElementById("estoque").value;
      const local = document.getElementById("local").value;

      try {
        const response = await fetch("http://127.0.0.1:5000/inserir", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            nome: nome,
           estoque: estoque,
            local: local
          })
        });

        const result = await response.json();
        document.getElementById("resposta").innerText = result.mensagem;
      } catch (error) {
        document.getElementById("resposta").innerText = "Erro: " + error;
      }
    });
  </script>
  <script>
	// Código para atualizar a página automaticamente e limpar as caixas de textos
	function clearTable() {
    location.reload();
}
document.getElementById("reloadPage").addEventListener("click", reloadPage);

  </script> 
		
<h2> Pesquisar Produtos</h2>		
<input type="text" id="campoBusca" placeholder="Digite o produto...">
<button onclick="pesquisar()">Pesquisar</button>
<button onclick="atualizar()">Atualizar</button>
<button onclick="excluirProduto()">Excluir</button>
<button onclick="reloadPage()">Omitir</button>
<div id="resultados"></div>

<script>
function pesquisar() {
    let termo = document.getElementById("campoBusca").value;

    fetch(`/pesquisar?termo=${encodeURIComponent(termo)}`)
        .then(response => response.json()) // <- agora tratamos JSON
        .then(data => {
            let container = document.getElementById("resultados");
            container.innerHTML = ""; // limpa resultados anteriores

            if (data.produtos.length === 0) {
                container.innerHTML = "<p>Nenhum produto encontrado.</p>";
                return;
            }

            // Cria lista de produtos
            let lista = document.createElement("ul");
            data.produtos.forEach(produto => {
                let item = document.createElement("li");
                // supondo que sua tabela tenha colunas 'codigo', 'nome',  'quantidade', local
                item.textContent = `Código: ${produto.codigo} - Nome: ${produto.nome} - Quantidade: ${produto.estoque} - Local: ${produto.local}`;
                lista.appendChild(item);
            });
            container.appendChild(lista);
        })
        .catch(error => {
            console.error("Erro na pesquisa:", error);
        });
}
</script>

  <h2>Lista de Produtos</h2>
  <ul id="listaProdutos"></ul>
<button onclick="fetchDados()">Exibir Lista</button>
	<button onclick="reloadPage()">Omitir Dados</button>
	
    <table id="tabela-dados">
        <thead id = "headone">
            <tr>
                <th>Código</th>
                <th>Nome</th>
                <th>Estoque</th>
                <th>Local</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os dados da tabela serão preenchidos aqui dinamicamente -->
        </tbody>
    </table>

    <script>
        function fetchDados() {
            fetch('/get-data') // Faz uma solicitação GET para o servidor
                .then(response => response.json())
                .then(data => {
                    const tabela = document.getElementById('tabela-dados').getElementsByTagName('tbody')[0];
                    tabela.innerHTML = ''; // Limpa os dados anteriores
                    data.forEach(linha => {
                        const novaLinha = tabela.insertRow(); // Cria uma nova linha
                        linha.forEach(celula => {
                            const novaCelula = novaLinha.insertCell(); // Cria uma nova célula
                            novaCelula.textContent = celula; // Insere o conteúdo na célula
                        });
                    });
                })
                .catch(error => console.error('Erro ao buscar os dados:', error));
        }
    </script>
	<script>
	// Código para atualizar a página automaticamente
	function reloadPage() {
    location.reload();
}

document.getElementById("reloadPage").addEventListener("click", reloadPage);


	</script> 
  <script>
   
    // Função para excluir produto
    function excluirProduto(codigo) {
     fetch('/excluir/${codigo}', {method: "DELETE"
	 })
	 .then(response => {
		if(!response.ok){
			return response.json().then(err => {
			throw new Error(err.error);});
			}
		return response.json();
		})
	.then(data => {
		if (data.success) {
			document.getElementById('linha-${codigo}').remove();
		} else {
			alert("Erro ao excluir o produto: " + data.error);
			}
	})
	.catch (error => { 
		console.error("Erro capturado: ", error);
		alert("Ocorreu um erro ao tentar excluir o produto:" + error.message);
		});
	}

     
  </script>
  <h2>Atualização de dados</h2>
  <label>Código:<input type="number" id="codigo" placeholder = "Código do produto"></label>
  <label>Nome:<input type="text" id="nome" placeholder="Novo nome">
  <label>Estoque: <input type="number" id="estoque" placeholder="Novo estoque"></label>
  <label>Local: <input type="text" id="local" placeholder="Novo local"></label><br><br>
  <script>
    function atualizar() {
      const codigo = document.getElementById("codigo").value;
      const nome = document.getElementById("nome").value;
	  const estoque = document.getElementById("estoque").value;
      const local = document.getElementById("local").value;

      fetch("/atualizar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ codigo: codigo, nome: nome, estoque: estoque, local:local })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.mensagem);
      })
      .catch(err => {
        alert("Erro: " + err);
      });
    }
  </script>

</body>
</html>

